{% extends "base.html" %}
{% block title %}Upload Video{% endblock %}

{% block content %}
<div class="admin-form-page">
  <h1 class="page-heading">Upload Video</h1>
  <div class="form-card glass">
    <!-- Upload Progress -->
    <div id="upload-progress" class="upload-progress" style="display: none;">
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <div class="progress-text">
        <span id="progress-percent">0%</span>
        <span id="progress-status">Uploading...</span>
      </div>
    </div>

    <form method="post" action="{{ url_for('admin_upload') }}" enctype="multipart/form-data" class="upload-form"
      id="upload-form">
      <label class="input-label" for="title">Title</label>
      <input type="text" id="title" name="title" class="input-field" placeholder="Video title" required>

      <label class="input-label" for="description">Description</label>
      <textarea id="description" name="description" class="input-field textarea" rows="4"
        placeholder="Optional description"></textarea>

      <label class="input-label" for="rank">Rank</label>
      <select id="rank" name="rank" class="input-field">
        <option value="free">Free</option>
        <option value="middle">Middle</option>
        <option value="top">Top</option>
      </select>

      <label class="input-label" for="video">Video file</label>
      <input type="file" id="video" name="video" class="input-field file-input" accept=".mp4,.webm,.mkv,.mov" required>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="upload-btn">Upload</button>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const form = document.getElementById('upload-form');
    const progressWrap = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const progressStatus = document.getElementById('progress-status');
    const uploadBtn = document.getElementById('upload-btn');
    // Maximum chunk size (20 MB)
    const CHUNK_SIZE = 20 * 1024 * 1024;

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const fileInput = document.getElementById('video');
      const file = fileInput.files[0];
      if (!file) {
        showError("Please select a video file");
        return;
      }

      // Prepare metadata
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const rank = document.getElementById('rank').value;
      const uploadId = uuidv4(); // Unique ID for this specific upload session

      // UI Updates
      progressWrap.style.display = 'block';
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Preparing...';

      // Start recursive upload
      uploadChunk(file, 0, uploadId, title, description, rank);
    });

    function uploadChunk(file, start, uploadId, title, description, rank) {
      const end = Math.min(start + CHUNK_SIZE, file.size);
      const chunk = file.slice(start, end);
      const isLastChunk = end >= file.size;

      const formData = new FormData();
      formData.append('video_chunk', chunk, file.name);
      formData.append('upload_id', uploadId);
      formData.append('chunk_start', start);
      formData.append('chunk_end', end);
      formData.append('total_size', file.size);
      formData.append('is_last_chunk', isLastChunk);

      // On the last chunk, we also send the metadata so the backend finishes the job
      if (isLastChunk) {
        formData.append('title', title);
        formData.append('description', description);
        formData.append('rank', rank);
      }

      uploadBtn.textContent = isLastChunk ? 'Finalizing...' : 'Uploading chunk...';

      const xhr = new XMLHttpRequest();
      xhr.open('POST', form.action);

      // We do NOT add upload progress tracking on the chunk request itself here, 
      // but instead update the progress based on completed chunks.
      xhr.upload.addEventListener('progress', function (e) {
        if (e.lengthComputable) {
          const currentUploaded = start + e.loaded;
          const percent = Math.min(Math.round((currentUploaded / file.size) * 100), 100);
          // Avoid dropping to 0% mid-chunk or jumping over 100 before final piece
          progressBar.style.width = percent + '%';
          progressPercent.textContent = percent + '%';
          progressStatus.textContent = 'Uploading... ' + formatBytes(currentUploaded) + ' / ' + formatBytes(file.size);
        }
      });

      xhr.addEventListener('load', function () {
        if (xhr.status === 200) {
          let response;
          try {
            response = JSON.parse(xhr.responseText);
          } catch (e) {
            // Fallback for non-JSON responses
            if (isLastChunk) {
              finishUploadSuccess();
              return;
            }
          }

          if (response && response.success) {
            if (isLastChunk) {
              finishUploadSuccess();
            } else {
              // Upload next chunk
              uploadChunk(file, end, uploadId, title, description, rank);
            }
          } else {
            showError(response ? response.error : 'Upload failed');
            resetForm();
          }
        } else {
          let errorMsg = 'Upload failed.';
          try {
            const r = JSON.parse(xhr.responseText);
            if (r.error) errorMsg = r.error;
          } catch (e) { }
          showError(errorMsg);
          resetForm();
        }
      });

      xhr.addEventListener('error', function () {
        showError('Network error. Please check your connection.');
        resetForm();
      });

      xhr.send(formData);
    }

    function finishUploadSuccess() {
      progressBar.style.width = '100%';
      progressPercent.textContent = '100%';
      progressStatus.textContent = 'Upload complete! Redirecting...';
      setTimeout(function () {
        window.location.href = "{{ url_for('admin_dashboard') }}";
      }, 1000);
    }

    // Simple UUID generator for tracking chunks on backend
    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function resetForm() {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload';
      setTimeout(function () {
        progressWrap.style.display = 'none';
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        progressStatus.textContent = 'Uploading...';
      }, 3000);
    }

    function showError(msg) {
      if (window.VideoHub && window.VideoHub.toast) {
        window.VideoHub.toast(msg, 'error');
      } else {
        alert(msg);
      }
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
  })();
</script>
{% endblock %}